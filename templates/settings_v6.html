{% extends "base_v6.html" %}

{% block title %}Settings{% endblock %}

{% block content %}
<!-- Smart Home Widget (decoy) - click lightbulb or button to toggle modes -->
<div class="smart-widget card" id="mode-toggle">
    <div class="widget-header">
        <span class="widget-icon" onclick="toggleMode()" style="cursor:pointer">üí°</span>
        <span class="widget-title">Living Room Lights</span>
        <button class="theme-toggle" id="theme-btn" onclick="toggleTheme()" title="Toggle dark mode">üåô</button>
        <button class="widget-toggle on" id="mode-btn" onclick="toggleMode()">ON</button>
    </div>
</div>

<!-- Real content (hidden when mode is OFF) -->
<div id="real-content">
<!-- Top bar with refresh -->
<div class="top-bar card">
    <div class="refresh-row">
        <button class="refresh-btn-nice" onclick="location.reload()">‚Üª</button>
        <span class="refresh-time">{{ last_refresh }}</span>
    </div>
</div>

<!-- Status message -->
<div id="status-msg" class="status-msg" style="display:none"></div>

<!-- Security & Privacy Settings -->
<div class="section card">
    <div class="section-header">
        <h2>Security & Privacy</h2>
        <span class="section-info">Configure timeout and password requirements</span>
    </div>

    <div class="settings-grid">
        <div class="setting-item">
            <label for="setting-fake_page_timeout_seconds">Fake Page Timeout (seconds)</label>
            <input type="number" id="setting-fake_page_timeout_seconds" value="{{ settings.fake_page_timeout_seconds or 180 }}" min="0" step="30">
            <span class="setting-help">Time before real page switches to fake light bulb page (0 = disabled)</span>
        </div>

        <div class="setting-item">
            <label for="setting-password_timeout_seconds">Password Timeout (seconds)</label>
            <input type="number" id="setting-password_timeout_seconds" value="{{ settings.password_timeout_seconds or 900 }}" min="0" step="60">
            <span class="setting-help">Time before password required again (0 = always require)</span>
        </div>

        <div class="setting-item">
            <label for="setting-session_timeout_minutes">Session Timeout (minutes)</label>
            <input type="number" id="setting-session_timeout_minutes" value="{{ settings.session_timeout_minutes or 15 }}" min="1" step="5">
            <span class="setting-help">Overall session timeout before auto-logout</span>
        </div>

        <div class="setting-item checkbox-item">
            <label>
                <input type="checkbox" id="setting-require_medi_password" {% if settings.require_medi_password %}checked{% endif %}>
                <span>Require separate password for Medi page</span>
            </label>
            <span class="setting-help">Additional security layer for sensitive media content</span>
        </div>
    </div>
</div>

<!-- UI/UX Settings -->
<div class="section card">
    <div class="section-header">
        <h2>UI & Display</h2>
        <span class="section-info">Customize appearance and behavior</span>
    </div>

    <div class="settings-grid">
        <div class="setting-item checkbox-item">
            <label>
                <input type="checkbox" id="setting-enable_dark_mode" {% if settings.enable_dark_mode %}checked{% endif %}>
                <span>Enable dark mode toggle</span>
            </label>
            <span class="setting-help">Show dark mode toggle in navigation</span>
        </div>

        <div class="setting-item">
            <label for="setting-default_theme">Default Theme</label>
            <select id="setting-default_theme">
                <option value="light" {% if settings.default_theme == 'light' %}selected{% endif %}>Light</option>
                <option value="dark" {% if settings.default_theme == 'dark' %}selected{% endif %}>Dark</option>
            </select>
            <span class="setting-help">Theme used on first visit or after clearing cookies</span>
        </div>

        <div class="setting-item checkbox-item">
            <label>
                <input type="checkbox" id="setting-show_tutorial_on_timeout" {% if settings.show_tutorial_on_timeout %}checked{% endif %}>
                <span>Show tutorial page on timeout</span>
            </label>
            <span class="setting-help">Display tutorial instead of blank page when session times out</span>
        </div>

        <div class="setting-item checkbox-item">
            <label>
                <input type="checkbox" id="setting-enable_smart_widget_decoy" {% if settings.enable_smart_widget_decoy %}checked{% endif %}>
                <span>Enable smart home widget decoy</span>
            </label>
            <span class="setting-help">Show fake smart home widget for privacy (light bulb toggle)</span>
        </div>
    </div>
</div>

<!-- Dashboard Behavior -->
<div class="section card">
    <div class="section-header">
        <h2>Dashboard Behavior</h2>
        <span class="section-info">Configure default behaviors and auto-actions</span>
    </div>

    <div class="settings-grid">
        <div class="setting-item checkbox-item">
            <label>
                <input type="checkbox" id="setting-auto_refresh_enabled" {% if settings.auto_refresh_enabled %}checked{% endif %}>
                <span>Enable auto-refresh</span>
            </label>
            <span class="setting-help">Automatically refresh pages to show new content</span>
        </div>

        <div class="setting-item">
            <label for="setting-auto_refresh_interval">Auto-refresh Interval (seconds)</label>
            <input type="number" id="setting-auto_refresh_interval" value="{{ settings.auto_refresh_interval or 30 }}" min="10" step="10">
            <span class="setting-help">How often to refresh when auto-refresh is enabled</span>
        </div>

        <div class="setting-item checkbox-item">
            <label>
                <input type="checkbox" id="setting-show_notification_count" {% if settings.show_notification_count %}checked{% endif %}>
                <span>Show unread count in title</span>
            </label>
            <span class="setting-help">Display unread message count in browser tab title</span>
        </div>

        <div class="setting-item">
            <label for="setting-messages_per_page">Messages per page</label>
            <input type="number" id="setting-messages_per_page" value="{{ settings.messages_per_page or 100 }}" min="10" step="10">
            <span class="setting-help">Number of messages to display per page</span>
        </div>

        <div class="setting-item">
            <label for="setting-locked_history_message_limit">Locked history message limit</label>
            <input type="number" id="setting-locked_history_message_limit" value="{{ settings.locked_history_message_limit or 10 }}" min="1" step="1">
            <span class="setting-help">Number of messages visible when history is locked (default: 10)</span>
        </div>

        <div class="setting-item">
            <label for="setting-locked_history_media_limit">Locked history media limit</label>
            <input type="number" id="setting-locked_history_media_limit" value="{{ settings.locked_history_media_limit or 5 }}" min="1" step="1">
            <span class="setting-help">Number of media items visible when history is locked (default: 5)</span>
        </div>

        <div class="setting-item">
            <label for="setting-refresh_after_send_delay">Refresh delay after send (seconds)</label>
            <input type="number" id="setting-refresh_after_send_delay" value="{{ settings.refresh_after_send_delay or 2 }}" min="0" max="10" step="0.5">
            <span class="setting-help">Time to wait before refreshing page after sending message (default: 2 seconds)</span>
        </div>
    </div>
</div>

<!-- Media Settings -->
<div class="section card">
    <div class="section-header">
        <h2>Media & Processing</h2>
        <span class="section-info">Configure media handling and processing</span>
    </div>

    <div class="settings-grid">
        <div class="setting-item checkbox-item">
            <label>
                <input type="checkbox" id="setting-auto_generate_thumbnails" {% if settings.auto_generate_thumbnails %}checked{% endif %}>
                <span>Auto-generate thumbnails</span>
            </label>
            <span class="setting-help">Automatically create thumbnails for uploaded media</span>
        </div>

        <div class="setting-item">
            <label for="setting-default_snapshot_count">Default snapshot count</label>
            <select id="setting-default_snapshot_count">
                <option value="3" {% if settings.default_snapshot_count == 3 %}selected{% endif %}>3</option>
                <option value="6" {% if settings.default_snapshot_count == 6 %}selected{% endif %}>6</option>
                <option value="9" {% if settings.default_snapshot_count == 9 %}selected{% endif %}>9</option>
                <option value="12" {% if settings.default_snapshot_count == 12 %}selected{% endif %}>12</option>
            </select>
            <span class="setting-help">Number of video snapshots to generate</span>
        </div>

        <div class="setting-item checkbox-item">
            <label>
                <input type="checkbox" id="setting-compress_images" {% if settings.compress_images %}checked{% endif %}>
                <span>Compress uploaded images</span>
            </label>
            <span class="setting-help">Reduce image file sizes to save storage space</span>
        </div>
    </div>
</div>

<!-- Notifications Settings -->
<div class="section card">
    <div class="section-header">
        <h2>Notifications</h2>
        <span class="section-info">Configure push notifications and testing</span>
    </div>

    <div class="settings-grid">
        <div class="setting-item checkbox-item">
            <label>
                <input type="checkbox" id="setting-notifications_enabled" {% if settings.notifications_enabled %}checked{% endif %}>
                <span>Enable push notifications</span>
            </label>
            <span class="setting-help">Allow browser notifications for new messages and events</span>
        </div>

        <div class="setting-item">
            <label for="test-notification-delay">Test Notification</label>
            <div style="display: flex; gap: 8px; align-items: center;">
                <input type="number" id="test-notification-delay" value="5" min="1" max="60" step="1" placeholder="Seconds" style="flex: 1;">
                <button class="action-btn" onclick="scheduleTestNotification()" style="padding: 8px 16px; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">Test Notification</button>
            </div>
            <span class="setting-help">Schedule a test notification after specified seconds (1-60)</span>
        </div>

        <div class="setting-item">
            <label for="test-badge-count">Test Badge</label>
            <div style="display: flex; gap: 8px; align-items: center;">
                <input type="number" id="test-badge-count" value="1" min="0" max="999" step="1" placeholder="Count" style="flex: 1;">
                <button class="action-btn" onclick="testBadge()" style="padding: 8px 16px; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">Test Badge</button>
            </div>
            <span class="setting-help">Set a badge count on the app Home Screen icon (0-999)</span>
        </div>
    </div>
</div>

<!-- Incept Settings -->
<div class="section card">
    <div class="section-header">
        <h2>Incept Processor</h2>
        <span class="section-info">Configure self-improvement automation</span>
    </div>

    <div class="settings-grid">
        <div class="setting-item">
            <label for="setting-incept_max_iterations">Max Iterations</label>
            <input type="number" id="setting-incept_max_iterations" value="{{ settings.incept_max_iterations or 50 }}" min="1" step="5">
            <span class="setting-help">Maximum iterations for Incept API loop</span>
        </div>

        <div class="setting-item">
            <label for="setting-incept_max_tokens">Max Tokens</label>
            <input type="number" id="setting-incept_max_tokens" value="{{ settings.incept_max_tokens or 4096 }}" min="1024" step="512">
            <span class="setting-help">Max tokens per API response</span>
        </div>

        <div class="setting-item checkbox-item">
            <label>
                <input type="checkbox" id="setting-incept_auto_push" {% if settings.incept_auto_push %}checked{% endif %}>
                <span>Auto-push completed changes</span>
            </label>
            <span class="setting-help">Automatically push to git after successful Incept completions</span>
        </div>

        <div class="setting-item checkbox-item">
            <label>
                <input type="checkbox" id="setting-incept_notify_on_complete" {% if settings.incept_notify_on_complete %}checked{% endif %}>
                <span>Notify when Incept completes</span>
            </label>
            <span class="setting-help">Show notification when Incept request finishes</span>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="action-bar card">
    <button class="action-btn save" onclick="saveSettings()">üíæ Save All Settings</button>
    <button class="action-btn reset" onclick="resetToDefaults()">‚Ü∫ Reset to Defaults</button>
    <button class="action-btn export" onclick="exportSettings()">üì• Export Settings</button>
</div>

</div><!-- end real-content -->

<style>
    .settings-grid {
        display: grid;
        gap: 20px;
    }

    .setting-item {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .setting-item label {
        font-weight: 500;
        font-size: 0.9rem;
        color: var(--text);
    }

    .setting-item.checkbox-item label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
    }

    .setting-item input[type="number"],
    .setting-item input[type="text"],
    .setting-item select {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: var(--bg);
        color: var(--text);
        font-size: 0.9rem;
        font-family: 'Inter', sans-serif;
    }

    .setting-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .setting-help {
        font-size: 0.8rem;
        color: var(--text-muted);
        line-height: 1.4;
    }

    .section {
        margin-bottom: 20px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border);
    }

    .section-header h2 {
        font-size: 1.1rem;
        font-weight: 600;
    }

    .section-info {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    .action-bar {
        display: flex;
        gap: 12px;
        justify-content: center;
        padding: 20px;
    }

    .action-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .action-btn.save {
        background: var(--accent);
        color: white;
    }

    .action-btn.save:hover {
        opacity: 0.9;
        transform: translateY(-1px);
    }

    .action-btn.reset {
        background: var(--bg);
        color: var(--text);
        border: 1px solid var(--border);
    }

    .action-btn.reset:hover {
        background: var(--border);
    }

    .action-btn.export {
        background: var(--bg);
        color: var(--text);
        border: 1px solid var(--border);
    }

    .action-btn.export:hover {
        background: var(--border);
    }

    .status-msg {
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 16px;
        font-size: 0.9rem;
    }

    .status-msg.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .status-msg.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding: 12px;
    }

    .refresh-row {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .refresh-btn-nice {
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 6px 12px;
        cursor: pointer;
        font-size: 1rem;
        color: var(--text);
    }

    .refresh-btn-nice:hover {
        background: var(--border);
    }

    .refresh-time {
        font-size: 0.8rem;
        color: var(--text-muted);
    }
</style>

<script>
function saveSettings() {
    const settings = {
        // Security & Privacy
        fake_page_timeout_seconds: parseInt(document.getElementById('setting-fake_page_timeout_seconds').value) || 180,
        password_timeout_seconds: parseInt(document.getElementById('setting-password_timeout_seconds').value) || 900,
        session_timeout_minutes: parseInt(document.getElementById('setting-session_timeout_minutes').value) || 15,
        require_medi_password: document.getElementById('setting-require_medi_password').checked,

        // UI/UX
        enable_dark_mode: document.getElementById('setting-enable_dark_mode').checked,
        default_theme: document.getElementById('setting-default_theme').value,
        show_tutorial_on_timeout: document.getElementById('setting-show_tutorial_on_timeout').checked,
        enable_smart_widget_decoy: document.getElementById('setting-enable_smart_widget_decoy').checked,

        // Dashboard Behavior
        auto_refresh_enabled: document.getElementById('setting-auto_refresh_enabled').checked,
        auto_refresh_interval: parseInt(document.getElementById('setting-auto_refresh_interval').value) || 30,
        show_notification_count: document.getElementById('setting-show_notification_count').checked,
        messages_per_page: parseInt(document.getElementById('setting-messages_per_page').value) || 100,
        locked_history_message_limit: parseInt(document.getElementById('setting-locked_history_message_limit').value) || 10,
        locked_history_media_limit: parseInt(document.getElementById('setting-locked_history_media_limit').value) || 5,
        refresh_after_send_delay: parseFloat(document.getElementById('setting-refresh_after_send_delay').value) || 2,

        // Media Settings
        auto_generate_thumbnails: document.getElementById('setting-auto_generate_thumbnails').checked,
        default_snapshot_count: parseInt(document.getElementById('setting-default_snapshot_count').value) || 6,
        compress_images: document.getElementById('setting-compress_images').checked,

        // Notifications
        notifications_enabled: document.getElementById('setting-notifications_enabled').checked,

        // Incept Settings
        incept_max_iterations: parseInt(document.getElementById('setting-incept_max_iterations').value) || 50,
        incept_max_tokens: parseInt(document.getElementById('setting-incept_max_tokens').value) || 4096,
        incept_auto_push: document.getElementById('setting-incept_auto_push').checked,
        incept_notify_on_complete: document.getElementById('setting-incept_notify_on_complete').checked
    };

    fetch('/api/config/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(settings)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showStatus('Settings saved successfully!', 'success');
        } else {
            showStatus('Failed to save settings: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(err => {
        showStatus('Error saving settings: ' + err.message, 'error');
    });
}

function resetToDefaults() {
    if (!confirm('Reset all settings to default values? This cannot be undone.')) {
        return;
    }

    fetch('/api/config/reset', {
        method: 'POST'
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showStatus('Settings reset to defaults. Refreshing...', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showStatus('Failed to reset settings', 'error');
        }
    })
    .catch(err => {
        showStatus('Error resetting settings: ' + err.message, 'error');
    });
}

function exportSettings() {
    fetch('/api/config/settings')
    .then(r => r.json())
    .then(settings => {
        const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'dashboard-settings.json';
        a.click();
        URL.revokeObjectURL(url);
        showStatus('Settings exported successfully', 'success');
    })
    .catch(err => {
        showStatus('Error exporting settings: ' + err.message, 'error');
    });
}

function showStatus(message, type) {
    const statusMsg = document.getElementById('status-msg');
    statusMsg.textContent = message;
    statusMsg.className = 'status-msg ' + type;
    statusMsg.style.display = 'block';
    setTimeout(() => {
        statusMsg.style.display = 'none';
    }, 5000);
}

// Test notification functionality
function scheduleTestNotification() {
    const delayInput = document.getElementById('test-notification-delay');
    let delay = parseInt(delayInput.value) || 5;

    // Clamp delay between 1 and 60 seconds
    delay = Math.max(1, Math.min(60, delay));
    delayInput.value = delay;

    // Check if notifications are supported
    if (!('Notification' in window)) {
        showStatus('Notifications are not supported in this browser', 'error');
        return;
    }

    // Request permission if needed
    if (Notification.permission === 'default') {
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                scheduleNotification(delay);
            } else {
                showStatus('Notification permission denied', 'error');
            }
        });
    } else if (Notification.permission === 'granted') {
        scheduleNotification(delay);
    } else {
        showStatus('Notification permission denied. Please enable notifications in your browser settings.', 'error');
    }
}

function scheduleNotification(delay) {
    showStatus(`Test notification scheduled in ${delay} second${delay !== 1 ? 's' : ''}...`, 'success');

    setTimeout(() => {
        // Create a test notification with the same style as real notifications
        const notification = new Notification('Home Assistant', {
            body: 'Test notification - System working correctly',
            icon: '/static/ha-icon.svg',
            badge: '/static/ha-icon.svg',
            tag: 'ha-test',
            requireInteraction: false,
            silent: false
        });

        // Auto-close after 5 seconds
        setTimeout(() => {
            try {
                notification.close();
            } catch (e) {
                // Notification may already be closed
            }
        }, 5000);

        // Do nothing on click (consistent with real notifications)
        notification.onclick = (e) => {
            e.preventDefault();
            notification.close();
        };

        console.log('[Settings] Test notification displayed');
    }, delay * 1000);
}

// Test badge functionality
async function testBadge() {
    const countInput = document.getElementById('test-badge-count');
    let count = parseInt(countInput.value) || 0;

    // Clamp count between 0 and 999
    count = Math.max(0, Math.min(999, count));
    countInput.value = count;

    // Check if badge API is supported
    if (!('setAppBadge' in navigator)) {
        showStatus('Badge API is not supported in this browser. Try Safari on iOS or Chrome/Edge.', 'error');
        return;
    }

    try {
        if (count > 0) {
            await navigator.setAppBadge(count);
            showStatus(`Badge set to ${count} on app icon`, 'success');
            console.log('[Settings] Badge set to:', count);
        } else {
            await navigator.clearAppBadge();
            showStatus('Badge cleared from app icon', 'success');
            console.log('[Settings] Badge cleared');
        }
    } catch (error) {
        showStatus('Failed to set badge: ' + error.message, 'error');
        console.error('[Settings] Badge error:', error);
    }
}

// Theme toggle (from base_v6.html)
function toggleTheme() {
    const html = document.documentElement;
    const currentTheme = html.getAttribute('data-theme') || 'light';
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    html.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);

    const btn = document.getElementById('theme-btn');
    btn.textContent = newTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
}

// Mode toggle (decoy widget)
function toggleMode() {
    const realContent = document.getElementById('real-content');
    const modeBtn = document.getElementById('mode-btn');
    const isOn = modeBtn.classList.contains('on');

    if (isOn) {
        modeBtn.classList.remove('on');
        modeBtn.classList.add('off');
        modeBtn.textContent = 'OFF';
        realContent.style.display = 'none';
    } else {
        modeBtn.classList.add('on');
        modeBtn.classList.remove('off');
        modeBtn.textContent = 'ON';
        realContent.style.display = 'block';
    }
}

// Initialize theme on load
document.addEventListener('DOMContentLoaded', () => {
    const savedTheme = localStorage.getItem('theme') || '{{ settings.default_theme or "light" }}';
    document.documentElement.setAttribute('data-theme', savedTheme);
    const themeBtn = document.getElementById('theme-btn');
    if (themeBtn) {
        themeBtn.textContent = savedTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
    }
});
</script>

{% endblock %}
