{% extends "base_v3.html" %}

{% block title %}Activity Monitor{% endblock %}

{% block content %}
<div class="log-header">
    ACTIVITY LOG • {{ history|length }} events • Page {{ page }}
    <span style="float:right">
        <a href="?page={{ page }}" onclick="location.reload();return false;" style="color:inherit;text-decoration:none;">[refresh]</a>
        {% if page > 1 %}<a href="?page={{ page - 1 }}" style="color:inherit;text-decoration:none;margin-left:8px;">[newer]</a>{% endif %}
        {% if has_more %}<a href="?page={{ page + 1 }}" style="color:inherit;text-decoration:none;margin-left:8px;">[older]</a>{% endif %}
    </span>
</div>

{% if history %}
<!-- Current State -->
<div class="current-state">
    {% set latest = history[0] %}
    <span class="state-indicator {{ latest.status }}"></span>
    <span class="state-text">
        Node <strong>{{ latest.username }}</strong>:
        {% if latest.status == 'online' %}ACTIVE{% elif latest.status == 'offline' %}INACTIVE{% else %}STANDBY{% endif %}
    </span>
    <span class="state-time">as of {{ latest.timestamp }}</span>
</div>

<!-- Activity Grid -->
<div class="content-area" style="margin-bottom:12px;">
    <div class="activity-header">24H ACTIVITY PATTERN</div>
    <div class="activity-grid">
        {% for entry in history[:72] %}
        <div class="activity-cell {{ entry.status }}" title="{{ entry.timestamp }}"></div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Event Log -->
<div class="content-area log-content">
    {% if history %}
    <div class="event-list">
        {% for entry in history %}
        <div class="event-row">
            <span class="event-time">{{ entry.timestamp }}</span>
            <span class="event-status {{ entry.status }}">
                {% if entry.status == 'online' %}▲ UP{% elif entry.status == 'offline' %}▼ DOWN{% else %}● IDLE{% endif %}
            </span>
            <span class="event-node">{{ entry.username }}</span>
            {% if entry.last_seen %}
            <span class="event-meta">last: {{ entry.last_seen }}</span>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-log">No activity events recorded.</div>
    {% endif %}
</div>

<div class="log-footer">
    <span class="legend-item"><span class="dot online"></span> Active/Online</span>
    <span class="legend-item"><span class="dot offline"></span> Inactive/Offline</span>
    <span class="legend-item"><span class="dot recently"></span> Standby/Recent</span>
</div>
{% endblock %}

{% block extra_styles %}
<style>
    .current-state {
        background: white;
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 12px 16px;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 12px;
    }

    .state-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .state-indicator.online { background: var(--online); }
    .state-indicator.offline { background: var(--offline); }
    .state-indicator.recently { background: #ca8a04; }

    .state-text {
        flex: 1;
    }

    .state-time {
        color: var(--text-muted);
        font-size: 11px;
    }

    .activity-header {
        font-size: 10px;
        color: var(--text-muted);
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }

    .activity-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 3px;
    }

    .activity-cell {
        width: 14px;
        height: 14px;
        border-radius: 2px;
        background: var(--bg-alt);
    }

    .activity-cell.online { background: var(--online); }
    .activity-cell.offline { background: #e5e7eb; }
    .activity-cell.recently { background: #fde047; }

    .log-content {
        font-family: 'JetBrains Mono', monospace;
        font-size: 11px;
        padding: 0;
        max-height: 400px;
        overflow-y: auto;
    }

    .event-list {
        display: table;
        width: 100%;
    }

    .event-row {
        display: table-row;
    }

    .event-row:hover {
        background: var(--bg-alt);
    }

    .event-row > span {
        display: table-cell;
        padding: 8px 12px;
        border-bottom: 1px solid var(--border);
        vertical-align: middle;
    }

    .event-time {
        color: var(--text-muted);
        white-space: nowrap;
        width: 150px;
    }

    .event-status {
        width: 70px;
        font-weight: 500;
    }

    .event-status.online { color: var(--online); }
    .event-status.offline { color: var(--offline); }
    .event-status.recently { color: #ca8a04; }

    .event-node {
        color: var(--text);
    }

    .event-meta {
        color: var(--text-muted);
        font-size: 10px;
    }

    .empty-log {
        color: var(--text-muted);
        font-style: italic;
        padding: 40px;
        text-align: center;
    }

    .log-footer {
        margin-top: 12px;
        padding: 10px 0;
        border-top: 1px solid var(--border);
        font-size: 10px;
        color: var(--text-muted);
        display: flex;
        gap: 16px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .dot {
        width: 8px;
        height: 8px;
        border-radius: 2px;
    }

    .dot.online { background: var(--online); }
    .dot.offline { background: var(--offline); }
    .dot.recently { background: #ca8a04; }

    @media (max-width: 600px) {
        .event-meta { display: none; }
        .event-time { width: auto; }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    setTimeout(() => location.reload(), 60000);
</script>
{% endblock %}
