{% extends "base_v6.html" %}

{% block title %}Control Room Summary{% endblock %}

{% block content %}
<style>
  .summary-container {
    width: 100%;
    height: calc(100vh - 100px);
    border: none;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  }

  .summary-iframe {
    width: 100%;
    height: 100%;
    border: none;
  }

  .loading-message {
    text-align: center;
    padding: 40px;
    font-size: 1.2rem;
    color: #888;
  }

  .error-message {
    text-align: center;
    padding: 40px;
    color: #ff6b6b;
  }

  .refresh-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    margin-top: 20px;
  }

  .refresh-btn:hover {
    opacity: 0.9;
  }
</style>

<div class="summary-container">
  <div id="loading" class="loading-message">
    Loading Control Room Summary... ‚è≥
  </div>
  <div id="error" class="error-message" style="display: none;">
    <p>Failed to load Control Room Summary</p>
    <p id="error-details" style="font-size: 0.9rem; margin-top: 10px; opacity: 0.8;"></p>
    <button class="refresh-btn" onclick="loadSummary()">Retry</button>
  </div>
  <iframe id="summary-iframe" class="summary-iframe" style="display: none;"></iframe>
</div>

<script>
  const CONTROL_ROOM_BASE = 'https://quantumlab-73wx.onrender.com';
  const API_KEY = '{{ config.CONTROL_ROOM_API_KEY }}';

  console.log('Control Room Base:', CONTROL_ROOM_BASE);
  console.log('API Key configured:', API_KEY ? 'Yes' : 'No');

  async function loadSummary() {
    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error');
    const iframe = document.getElementById('summary-iframe');

    try {
      loadingEl.style.display = 'block';
      errorEl.style.display = 'none';
      iframe.style.display = 'none';

      // Generate embed token from Control Room
      const response = await fetch(`${CONTROL_ROOM_BASE}/api/generate-embed-token`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${API_KEY}`,
          'Content-Type': 'application/json'
        }
      });

      if (!response.ok) {
        throw new Error(`Failed to generate token: ${response.status}`);
      }

      const data = await response.json();
      const token = data.token;

      // Load summary page with token
      iframe.src = `${CONTROL_ROOM_BASE}/summary.html?token=${token}`;

      // Show iframe when loaded
      iframe.onload = () => {
        loadingEl.style.display = 'none';
        iframe.style.display = 'block';
      };

      iframe.onerror = () => {
        throw new Error('Failed to load iframe');
      };

    } catch (err) {
      console.error('Error loading Control Room summary:', err);
      loadingEl.style.display = 'none';
      errorEl.style.display = 'block';
      document.getElementById('error-details').textContent = err.message || String(err);
    }
  }

  // Auto-reload token before it expires (every 4 minutes, token expires in 5)
  function setupAutoRefresh() {
    setInterval(() => {
      console.log('Refreshing Control Room embed token...');
      loadSummary();
    }, 4 * 60 * 1000);
  }

  // Load summary on page load
  document.addEventListener('DOMContentLoaded', () => {
    loadSummary();
    setupAutoRefresh();
  });
</script>
{% endblock %}
